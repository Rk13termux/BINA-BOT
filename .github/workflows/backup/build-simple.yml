name: Build BINA-BOT APK & EXE

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - debug
        - release

jobs:
  # Job para compilar APK Android
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“ Checkout repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ“± Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'
        cache: true

    - name: ğŸ” Verify Flutter installation
      run: flutter doctor -v

    - name: ğŸ“¦ Get Flutter dependencies
      run: flutter pub get

    - name: ğŸ§¹ Clean project
      run: flutter clean

    - name: ğŸ“¦ Get dependencies again
      run: flutter pub get

    - name: ï¿½ Analyze code
      run: flutter analyze --no-fatal-infos
      continue-on-error: true

    - name: ï¿½ğŸ”¨ Build APK (Debug)
      if: github.event.inputs.build_type == 'debug' || contains(github.ref, 'develop')
      run: flutter build apk --debug

    - name: ğŸš€ Build APK (Release)
      if: github.event.inputs.build_type == 'release' || github.ref == 'refs/heads/main'
      run: flutter build apk --release

    - name: ğŸ·ï¸ Get version
      id: version
      run: |
        VERSION=$(grep 'version:' pubspec.yaml | cut -d ' ' -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: ğŸ“¤ Upload Debug APK
      if: github.event.inputs.build_type == 'debug' || contains(github.ref, 'develop')
      uses: actions/upload-artifact@v4
      with:
        name: bina-bot-debug-apk-v${{ steps.version.outputs.version }}
        path: build/app/outputs/flutter-apk/app-debug.apk

    - name: ğŸ“¤ Upload Release APK
      if: github.event.inputs.build_type == 'release' || github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: bina-bot-release-apk-v${{ steps.version.outputs.version }}
        path: build/app/outputs/flutter-apk/app-release.apk

  # Job para compilar EXE Windows
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“± Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'
        cache: true

    - name: ğŸ” Verify Flutter installation
      run: flutter doctor -v

    - name: ğŸ“¦ Get Flutter dependencies
      run: flutter pub get

    - name: ğŸ§¹ Clean project
      run: flutter clean

    - name: ğŸ“¦ Get dependencies again
      run: flutter pub get

    - name: ï¿½ Analyze code
      run: flutter analyze --no-fatal-infos
      continue-on-error: true

    - name: ï¿½ğŸ–¥ï¸ Enable Windows desktop
      run: flutter config --enable-windows-desktop

    - name: ğŸ”¨ Build Windows EXE (Debug)
      if: github.event.inputs.build_type == 'debug' || contains(github.ref, 'develop')
      run: flutter build windows --debug

    - name: ğŸš€ Build Windows EXE (Release)
      if: github.event.inputs.build_type == 'release' || github.ref == 'refs/heads/main'
      run: flutter build windows --release

    - name: ğŸ·ï¸ Get version
      id: version
      shell: powershell
      run: |
        $version = (Select-String -Path "pubspec.yaml" -Pattern "version:").Line.Split(" ")[1]
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT

    - name: ğŸ“ Create Windows Release Package
      if: github.event.inputs.build_type == 'release' || github.ref == 'refs/heads/main'
      shell: powershell
      run: |
        $sourcePath = "build\windows\x64\runner\Release"
        $destPath = "bina-bot-windows-v${{ steps.version.outputs.version }}"
        Copy-Item -Path $sourcePath -Destination $destPath -Recurse
        Compress-Archive -Path $destPath -DestinationPath "$destPath.zip"

    - name: ğŸ“ Create Windows Debug Package
      if: github.event.inputs.build_type == 'debug' || contains(github.ref, 'develop')
      shell: powershell
      run: |
        $sourcePath = "build\windows\x64\runner\Debug"
        $destPath = "bina-bot-windows-debug-v${{ steps.version.outputs.version }}"
        Copy-Item -Path $sourcePath -Destination $destPath -Recurse
        Compress-Archive -Path $destPath -DestinationPath "$destPath.zip"

    - name: ğŸ“¤ Upload Windows Release
      if: github.event.inputs.build_type == 'release' || github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: bina-bot-windows-v${{ steps.version.outputs.version }}
        path: bina-bot-windows-v${{ steps.version.outputs.version }}.zip

    - name: ğŸ“¤ Upload Windows Debug
      if: github.event.inputs.build_type == 'debug' || contains(github.ref, 'develop')
      uses: actions/upload-artifact@v4
      with:
        name: bina-bot-windows-debug-v${{ steps.version.outputs.version }}
        path: bina-bot-windows-debug-v${{ steps.version.outputs.version }}.zip

  # Job para crear release automÃ¡tico
  create-release:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build-android, build-windows]
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ·ï¸ Get version
      id: version
      run: |
        VERSION=$(grep 'version:' pubspec.yaml | cut -d ' ' -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: ğŸ“¥ Download Android APK
      uses: actions/download-artifact@v4
      with:
        name: bina-bot-release-apk-v${{ steps.version.outputs.version }}

    - name: ğŸ“¥ Download Windows EXE
      uses: actions/download-artifact@v4
      with:
        name: bina-bot-windows-v${{ steps.version.outputs.version }}

    - name: ğŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: BINA-BOT v${{ steps.version.outputs.version }}
        body: |
          ğŸš€ **BINA-BOT v${{ steps.version.outputs.version }}**
          
          ### ğŸ“± Download Links:
          - **Android APK**: `app-release.apk`
          - **Windows EXE**: `bina-bot-windows-v${{ steps.version.outputs.version }}.zip`
          
          ### âœ¨ Features:
          - Professional cryptocurrency trading platform
          - Real-time market data and analysis
          - Advanced news scraping and filtering
          - Technical indicators and charts
          - Portfolio tracking and alerts
          - Multi-platform support (Android, Windows)
          
          ### ğŸ”§ Installation:
          - **Android**: Install the APK file
          - **Windows**: Extract ZIP and run the executable
          
          ---
          Built with â¤ï¸ using Flutter & GitHub Actions
        files: |
          app-release.apk
          bina-bot-windows-v${{ steps.version.outputs.version }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
