name: ï¿½ Multi-Platform Builder (Advanced)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Tipo de build'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - android-only
        - windows-only
        - web-only
      release_version:
        description: 'VersiÃ³n del release (opcional)'
        required: false
        type: string

env:
  FLUTTER_VERSION: '3.27.1'
  JAVA_VERSION: '17'
  NODE_VERSION: '18'

jobs:
  # Job unificado para todas las plataformas
  build-multiplatform:
    name: ðŸ”¨ Build All Platforms
    runs-on: windows-latest
    timeout-minutes: 90
    continue-on-error: false
    
    strategy:
      matrix:
        include:
          - platform: android
            artifact_name: "invictus-trader-android"
            artifact_path: "build/app/outputs/flutter-apk/"
            build_command: "flutter build apk --release --split-per-abi"
            icon: "ðŸ¤–"
          - platform: windows
            artifact_name: "invictus-trader-windows"
            artifact_path: "build/windows/x64/runner/Release/"
            build_command: "flutter build windows --release"
            icon: "ðŸªŸ"
          - platform: web
            artifact_name: "invictus-trader-web"
            artifact_path: "build/web/"
            build_command: "flutter build web --release --web-renderer html"
            icon: "ðŸŒ"
    
    steps:
    # ========================================
    # ðŸ”§ SETUP ENVIRONMENT
    # ========================================
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: âš¡ Setup Flutter Cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ${{ runner.tool_cache }}/flutter
        key: flutter-${{ env.FLUTTER_VERSION }}-${{ runner.os }}-${{ hashFiles('pubspec.yaml') }}
        restore-keys: |
          flutter-${{ env.FLUTTER_VERSION }}-${{ runner.os }}-

    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ðŸ”§ Pre-build Checks & Cleanup
      run: |
        echo "ðŸ”§ Pre-build environment checks..."
        
        # Check available space
        echo "ðŸ’¾ Available disk space:"
        df -h
        echo ""
        
        # Clean any previous builds
        echo "ðŸ§¹ Cleaning previous builds..."
        flutter clean || echo "No previous builds to clean"
        
        # Verify Flutter installation
        echo "ðŸ¦ Flutter verification:"
        flutter --version
        flutter config --list
        echo ""

    - name: â˜• Setup Java (Android)
      if: matrix.platform == 'android' || github.event.inputs.build_type == 'all' || github.event.inputs.build_type == 'android-only'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: ðŸŸ¢ Setup Node.js (Web)
      if: matrix.platform == 'web' || github.event.inputs.build_type == 'all' || github.event.inputs.build_type == 'web-only'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'web/package-lock.json'

    # ========================================
    # ðŸ” PROJECT ANALYSIS
    # ========================================
    - name: ðŸ” Flutter Doctor & Analysis
      run: |
        echo "ðŸ” Analyzing Flutter environment..."
        flutter doctor -v
        echo ""
        echo "ðŸ“Š Project Analysis:"
        flutter --version
        flutter config --list
        echo ""
        echo "ðŸ“¦ Dependencies:"
        flutter pub deps

    - name: ðŸ“¦ Install Dependencies
      run: |
        echo "ðŸ“¦ Installing Flutter dependencies..."
        # Retry logic for network issues
        for i in {1..3}; do
          echo "Attempt $i/3..."
          if flutter pub get; then
            echo "âœ… Dependencies installed successfully"
            break
          else
            echo "âŒ Attempt $i failed, retrying..."
            sleep 5
          fi
          if [ $i -eq 3 ]; then
            echo "âŒ Failed to install dependencies after 3 attempts"
            exit 1
          fi
        done
        echo ""
        echo "ðŸ”§ Running build runner (if needed)..."
        flutter packages pub run build_runner build --delete-conflicting-outputs || echo "No build runner configured"

    # ========================================
    # ðŸ§ª QUALITY CHECKS
    # ========================================
    - name: ðŸ§ª Code Quality & Tests
      run: |
        echo "ðŸ” Running Flutter analyze..."
        flutter analyze --no-fatal-infos
        echo ""
        echo "ðŸ§ª Running tests..."
        flutter test --coverage || echo "No tests found"
        echo ""
        echo "ðŸ“ Code metrics..."
        find lib -name "*.dart" | wc -l | xargs echo "Dart files:"
        find lib -name "*.dart" -exec wc -l {} + | tail -1 | xargs echo "Total lines:"

    # ========================================
    # ðŸ› ï¸ PLATFORM-SPECIFIC BUILDS
    # ========================================
    - name: ${{ matrix.icon }} Build ${{ matrix.platform }}
      run: |
        echo "${{ matrix.icon }} Starting ${{ matrix.platform }} build..."
        
        # Platform-specific preparations
        if [ "${{ matrix.platform }}" == "android" ]; then
          echo "ðŸ¤– Preparing Android build..."
          flutter config --enable-android
          # Create keystore for release (using debug for demo)
          echo "ðŸ“± Android build configuration ready"
        elif [ "${{ matrix.platform }}" == "windows" ]; then
          echo "ðŸªŸ Preparing Windows build..."
          flutter config --enable-windows-desktop
          echo "ðŸ’» Windows build configuration ready"
        elif [ "${{ matrix.platform }}" == "web" ]; then
          echo "ðŸŒ Preparing Web build..."
          flutter config --enable-web
          echo "ðŸ•¸ï¸ Web build configuration ready"
        fi
        
        echo ""
        echo "ðŸ”¨ Executing build command: ${{ matrix.build_command }}"
        
        # Retry logic for builds
        for i in {1..2}; do
          echo "Build attempt $i/2..."
          if ${{ matrix.build_command }}; then
            echo "âœ… Build completed successfully!"
            break
          else
            echo "âŒ Build attempt $i failed"
            if [ $i -eq 2 ]; then
              echo "âŒ Build failed after 2 attempts"
              exit 1
            else
              echo "ðŸ”„ Cleaning and retrying..."
              flutter clean
              flutter pub get
              sleep 10
            fi
          fi
        done
        
        # Verify build artifacts
        if [ -d "${{ matrix.artifact_path }}" ]; then
          echo "ðŸ“ Build artifacts found:"
          ls -la "${{ matrix.artifact_path }}"
        else
          echo "âŒ Build artifacts not found at expected path"
          exit 1
        fi
      shell: bash

    # ========================================
    # ðŸ“Š BUILD VERIFICATION
    # ========================================
    - name: ðŸ“Š Verify Build Artifacts
      run: |
        echo "ðŸ“Š Verifying ${{ matrix.platform }} build artifacts..."
        
        if [ "${{ matrix.platform }}" == "android" ]; then
          echo "ðŸ¤– Android APK verification:"
          find build/app/outputs -name "*.apk" -exec ls -lh {} \;
          echo ""
          echo "ðŸ“± APK details:"
          find build/app/outputs -name "*.apk" -exec file {} \;
        elif [ "${{ matrix.platform }}" == "windows" ]; then
          echo "ðŸªŸ Windows EXE verification:"
          find build/windows -name "*.exe" -exec ls -lh {} \;
          echo ""
          echo "ðŸ’» EXE details:"
          find build/windows -name "*.exe" -exec file {} \;
        elif [ "${{ matrix.platform }}" == "web" ]; then
          echo "ðŸŒ Web build verification:"
          ls -la build/web/
          echo ""
          echo "ðŸ•¸ï¸ Web bundle size:"
          du -sh build/web/
        fi
      shell: bash

    # ========================================
    # ðŸ“¦ ARTIFACT PACKAGING
    # ========================================
    - name: ðŸ“¦ Package Artifacts
      run: |
        echo "ðŸ“¦ Packaging ${{ matrix.platform }} artifacts..."
        
        # Create release directory
        mkdir -p release/${{ matrix.platform }}
        
        if [ "${{ matrix.platform }}" == "android" ]; then
          echo "ðŸ“± Packaging Android APKs..."
          cp -r build/app/outputs/flutter-apk/* release/android/
          # Create a combined release package
          cd release/android
          zip -r ../invictus-trader-android-release.zip .
          cd ../..
        elif [ "${{ matrix.platform }}" == "windows" ]; then
          echo "ðŸ’» Packaging Windows executable..."
          cp -r build/windows/x64/runner/Release/* release/windows/
          # Create installer-like structure
          cd release/windows
          zip -r ../invictus-trader-windows-release.zip .
          cd ../..
        elif [ "${{ matrix.platform }}" == "web" ]; then
          echo "ðŸŒ Packaging Web application..."
          cp -r build/web/* release/web/
          cd release/web
          zip -r ../invictus-trader-web-release.zip .
          cd ../..
        fi
        
        echo "âœ… Packaging completed!"
        ls -la release/
      shell: bash

    # ========================================
    # â¬†ï¸ UPLOAD ARTIFACTS
    # ========================================
    - name: â¬†ï¸ Upload ${{ matrix.platform }} Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}-${{ github.run_number }}
        path: release/${{ matrix.platform }}/
        retention-days: 30
        compression-level: 6

    - name: ðŸ“‹ Build Summary
      run: |
        echo "## ðŸŽ‰ ${{ matrix.platform }} Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | ${{ matrix.icon }} ${{ matrix.platform }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Command | \`${{ matrix.build_command }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact Path | \`${{ matrix.artifact_path }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Time | $(date -u) |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ matrix.platform }}" == "android" ]; then
          echo "### ðŸ“± Android Build Details" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find build/app/outputs -name "*.apk" -exec ls -lh {} \; >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ matrix.platform }}" == "windows" ]; then
          echo "### ðŸ’» Windows Build Details" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find build/windows -name "*.exe" -exec ls -lh {} \; >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ matrix.platform }}" == "web" ]; then
          echo "### ðŸŒ Web Build Details" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -sh build/web/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi

  # ========================================
  # ðŸš€ UNIFIED RELEASE JOB
  # ========================================
  create-unified-release:
    name: ðŸš€ Create Unified Release
    needs: build-multiplatform
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: â¬‡ï¸ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: ðŸ“¦ Prepare Unified Release
      run: |
        echo "ðŸ“¦ Preparing unified release package..."
        
        # Create release structure
        mkdir -p unified-release/{android,windows,web}
        
        # Copy artifacts
        if [ -d "artifacts/invictus-trader-android-${{ github.run_number }}" ]; then
          cp -r artifacts/invictus-trader-android-${{ github.run_number }}/* unified-release/android/
        fi
        
        if [ -d "artifacts/invictus-trader-windows-${{ github.run_number }}" ]; then
          cp -r artifacts/invictus-trader-windows-${{ github.run_number }}/* unified-release/windows/
        fi
        
        if [ -d "artifacts/invictus-trader-web-${{ github.run_number }}" ]; then
          cp -r artifacts/invictus-trader-web-${{ github.run_number }}/* unified-release/web/
        fi
        
        # Create README for release
        cat > unified-release/README.md << 'EOF'
        # ðŸ† Invictus Trader Pro - Release Package
        
        ## ðŸ“± Android
        - **APK Files**: `/android/` folder
        - **Installation**: Install APK on Android device
        - **Requirements**: Android 8.0+ (API 26+)
        
        ## ðŸ’» Windows
        - **Executable**: `/windows/invictus_trader_pro.exe`
        - **Installation**: Extract and run executable
        - **Requirements**: Windows 10/11 64-bit
        
        ## ðŸŒ Web
        - **Web App**: `/web/` folder
        - **Deployment**: Upload to web server
        - **Access**: Open `index.html` in browser
        
        ## ðŸš€ Features
        - âœ… Real-time cryptocurrency data
        - âœ… Premium AI predictions
        - âœ… Advanced technical indicators
        - âœ… News sentiment analysis
        - âœ… Portfolio management
        - âœ… Professional dark theme with gold accents
        
        ## ðŸ“ž Support
        Built with â¤ï¸ by Invictus Trading Solutions
        EOF
        
        # Create unified package
        cd unified-release
        zip -r ../invictus-trader-pro-unified-release.zip .
        cd ..
        
        echo "âœ… Unified release package created!"
        ls -la *.zip

    - name: ðŸ·ï¸ Generate Release Tag
      id: tag
      run: |
        if [ "${{ github.event.inputs.release_version }}" != "" ]; then
          echo "tag=v${{ github.event.inputs.release_version }}" >> $GITHUB_OUTPUT
        else
          echo "tag=v$(date +'%Y.%m.%d')-build-${{ github.run_number }}" >> $GITHUB_OUTPUT
        fi

    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "ðŸ† Invictus Trader Pro ${{ steps.tag.outputs.tag }}"
        body: |
          ## ðŸŽ‰ New Release: Invictus Trader Pro
          
          ### ðŸ“¦ What's Included
          - ðŸ¤– **Android APK**: Ready to install on Android devices
          - ðŸªŸ **Windows EXE**: Standalone executable for Windows
          - ðŸŒ **Web App**: Browser-based application
          
          ### âœ¨ Features
          - âœ… Real-time cryptocurrency market data
          - âœ… Premium AI-powered predictions
          - âœ… Advanced technical analysis tools
          - âœ… News sentiment analysis
          - âœ… Professional trading interface
          - âœ… Multi-platform support
          
          ### ðŸš€ Quick Start
          1. **Android**: Download and install the APK
          2. **Windows**: Extract and run the EXE
          3. **Web**: Upload web folder to your server
          
          ### ðŸ“Š Build Info
          - **Commit**: `${{ github.sha }}`
          - **Build**: #${{ github.run_number }}
          - **Date**: $(date -u)
          - **Flutter**: ${{ env.FLUTTER_VERSION }}
          
          ---
          Built with â¤ï¸ using Flutter & GitHub Actions
        files: |
          invictus-trader-pro-unified-release.zip
          unified-release/README.md
        draft: false
        prerelease: ${{ github.ref != 'refs/heads/main' }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“‹ Release Summary
      run: |
        echo "## ðŸŽ‰ Unified Release Created!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Release Details" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Tag | \`${{ steps.tag.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Platforms | ðŸ¤– Android â€¢ ðŸªŸ Windows â€¢ ðŸŒ Web |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Number | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Package Contents" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -la unified-release/ >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # ðŸ§¹ CLEANUP JOB
  # ========================================
  cleanup:
    name: ðŸ§¹ Cleanup
    needs: [build-multiplatform, create-unified-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ§¹ Cleanup Old Artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });
          
          console.log(`Found ${artifacts.data.artifacts.length} artifacts`);
          
          // Keep only the most recent 10 artifacts
          const oldArtifacts = artifacts.data.artifacts.slice(10);
          
          for (const artifact of oldArtifacts) {
            try {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
              console.log(`Deleted artifact: ${artifact.name}`);
            } catch (error) {
              console.log(`Failed to delete artifact ${artifact.name}: ${error.message}`);
            }
          }

    - name: ðŸ“Š Workflow Summary
      run: |
        echo "## ðŸŽ¯ Workflow Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Achievements" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¤– Android APK built and tested" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸªŸ Windows EXE compiled successfully" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ Web application built and optimized" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ Unified release package created" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸš€ GitHub release published" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ‰ Ready for Production!" >> $GITHUB_STEP_SUMMARY
        echo "Your Invictus Trader Pro app is now ready for deployment across all platforms." >> $GITHUB_STEP_SUMMARY
