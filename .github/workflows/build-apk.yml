name: 🚀 Build Invictus Trader Pro APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release

jobs:
  build-apk:
    name: 📱 Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: 🐦 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: 📦 Get Dependencies
      run: flutter pub get
      
    - name: 🔍 Analyze Code
      run: flutter analyze --no-fatal-infos
      
    - name: 🧪 Run Tests
      run: flutter test --no-pub --coverage
      continue-on-error: true
      
    - name: 📝 Create .env File
      run: |
        cat > .env << 'EOF'
        # Invictus Trader Pro - GitHub Actions Build
        BINANCE_API_KEY=demo_key_for_build
        BINANCE_SECRET_KEY=demo_secret_for_build
        BINANCE_BASE_URL=https://testnet.binance.vision
        BINANCE_TESTNET_URL=https://testnet.binance.vision
        BINANCE_WS_URL=wss://testnet.binance.vision/ws
        BINANCE_WS_TESTNET_URL=wss://testnet.binance.vision/ws
        
        # Groq AI Configuration
        GROQ_API_KEY=demo_groq_key_for_build
        GROQ_BASE_URL=https://api.groq.com/openai/v1/chat/completions
        GROQ_MODEL=llama-3.3-70b-versatile
        GROQ_MAX_TOKENS=2048
        GROQ_TEMPERATURE=0.2
        
        # Application Configuration
        APP_NAME=Invictus Trader Pro
        APP_VERSION=1.0.0
        DEBUG_MODE=true
        LOG_LEVEL=info
        REFRESH_INTERVAL_MS=1000
        
        # Features Toggle
        ENABLE_AI_ANALYSIS=false
        ENABLE_REAL_TRADING=false
        ENABLE_PAPER_TRADING=true
        ENABLE_WEBSOCKET=false
        
        # Security Settings
        ENCRYPT_STORAGE=true
        SESSION_TIMEOUT_MINUTES=60
        
        # Performance Settings
        MAX_CANDLES_CACHE=500
        WEBSOCKET_RECONNECT_DELAY_MS=10000
        API_REQUEST_TIMEOUT_MS=15000
        
        # UI Settings
        DEFAULT_THEME=dark
        DEFAULT_SYMBOL=BTCUSDT
        DEFAULT_TIMEFRAME=1h
        ENABLE_SOUND_ALERTS=false
        ENABLE_PUSH_NOTIFICATIONS=false
        EOF
        
    - name: 🔨 Build Debug APK
      if: github.event.inputs.release_type == 'debug' || github.event.inputs.release_type == ''
      run: |
        flutter build apk --debug --verbose
        
    - name: 🏗️ Build Release APK
      if: github.event.inputs.release_type == 'release'
      run: |
        flutter build apk --release --verbose
        
    - name: 📱 Get Build Info
      id: build_info
      run: |
        if [ "${{ github.event.inputs.release_type }}" == "release" ]; then
          echo "apk_path=build/app/outputs/flutter-apk/app-release.apk" >> $GITHUB_OUTPUT
          echo "apk_name=InvictusTraderPro-release-$(date +%Y%m%d-%H%M%S).apk" >> $GITHUB_OUTPUT
        else
          echo "apk_path=build/app/outputs/flutter-apk/app-debug.apk" >> $GITHUB_OUTPUT
          echo "apk_name=InvictusTraderPro-debug-$(date +%Y%m%d-%H%M%S).apk" >> $GITHUB_OUTPUT
        fi
        
    - name: 📊 APK File Info
      run: |
        if [ -f "${{ steps.build_info.outputs.apk_path }}" ]; then
          echo "✅ APK Build Successful!"
          echo "📁 File: ${{ steps.build_info.outputs.apk_path }}"
          echo "📏 Size: $(du -h ${{ steps.build_info.outputs.apk_path }} | cut -f1)"
          echo "🕒 Date: $(date)"
          ls -la build/app/outputs/flutter-apk/
        else
          echo "❌ APK Build Failed!"
          exit 1
        fi
        
    - name: 🚀 Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.build_info.outputs.apk_name }}
        path: ${{ steps.build_info.outputs.apk_path }}
        retention-days: 30
        
    - name: 📋 Build Summary
      run: |
        echo "## 🎉 Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📱 APK Information" >> $GITHUB_STEP_SUMMARY
        echo "- **File Name:** ${{ steps.build_info.outputs.apk_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type:** ${{ github.event.inputs.release_type || 'debug' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Size:** $(du -h ${{ steps.build_info.outputs.apk_path }} | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🚀 Features Included" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Professional Trading Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ AI Analysis with Groq Integration" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ 100+ Technical Indicators" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Real-time Price Monitoring" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Binance API Integration" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Portfolio Tracking" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ WebSocket Live Data" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📥 Download" >> $GITHUB_STEP_SUMMARY
        echo "The APK is available in the **Artifacts** section above." >> $GITHUB_STEP_SUMMARY

  notify-completion:
    name: 📢 Notify Build Completion
    runs-on: ubuntu-latest
    needs: build-apk
    if: always()
    
    steps:
    - name: 📣 Build Status
      run: |
        if [ "${{ needs.build-apk.result }}" == "success" ]; then
          echo "🎉 BUILD SUCCESSFUL!"
          echo "✅ Invictus Trader Pro APK has been built successfully"
          echo "📱 Ready for download from GitHub Actions artifacts"
        else
          echo "❌ BUILD FAILED!"
          echo "💥 There was an error building the APK"
          echo "🔍 Check the build logs for details"
        fi
